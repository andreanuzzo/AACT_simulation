---
title: "SIR_basic"
author: "Andrea Nuzzo"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
home = file.path('~/Documents/MIT/SafeKit_model/')
```

```{r}
library(deSolve)
library(tidyverse)
library(ggthemes)
```

# Basic SIR
Model is:

$\displaystyle \frac{\partial S}{\partial t} = - \frac{SI}{N}$

$\displaystyle \frac{\partial I}{\partial t} = \beta \frac{SI}{N} - \gamma \frac{I}{N}$

$\displaystyle \frac{\partial R}{\partial t} =  \gamma \frac{I}{N}$

$\beta = cp$

$R0 = cpd$

$S$ = proportion of susceptible individuals in total population
$I$ = proportion of infected individuals in total population
$R$ = proportion of recovered individuals in total population
$\beta$ = transmission parameter (rate of infection for susceptible-infected contact)
$\gamma$ = recovery parameter (rate of infected transitioning to recovered)
$c$ =number of contacts each host has per unit time (contact rate)
$p$ = probability of transmission of infection per contact (transmissibility)
$t$ = evaluation time in days
$d$ = infectious period (days)

## Assumptions

Set conditions as follows:

```{r}
US_pop_2020 = 329410596 # US population based on census = N
Infected = 14250 # total infected based on [JHU dashboard data](https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6) at March 20
Recovered = 121  # total recovered based on [JHU dashboard data](https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6) at March 20
Susceptible = US_pop_2020 - Infected
d = 14 #estimted contagious asymptomatic
obs_time = 180
R0 = 3.3 # estimated R0
gamm = 1/d # need to check this 
bet = R0/d
```

```{r}
SIR.model <- function(Suscep, Infect, Rec, Tot_pop, t, b, g){ 
  
  init <- c(S_prop = Suscep/Tot_pop,
            Inf_prop = Infect/Tot_pop,
            Rec_prop = Rec/Tot_pop )
  
  parameters <- c(bet=b,gamm=g) 
  time <- seq(0,t,by=t/(2*length(1:t))) 
  
  eqn <- function(time,state,parameters){ 
    with(as.list(c(state,parameters)),{ 
      dS <- -bet*S_prop*Inf_prop
      dI <- bet*S_prop*Inf_prop-gamm*Inf_prop 
      dR <- gamm*Inf_prop
      return(list(c(dS,
                    dI,
                    dR)
                  ))}
      ) 
  }
  
  out<-ode(y=init,times=time,eqn,parms=parameters) 
  out.df<-as.data.frame(out) 
}
```

```{r}
SIR.model(Susceptible, Infected, Recovered, US_pop_2020, obs_time, bet, gamm) %>% 
  as.data.frame() %>% 
  gather(Compartments, value, -time) %>% 
  ggplot() +
  aes(x=time, y= value, color= Compartments) +
  geom_line() +
  theme_clean() + 
  scale_color_pander()
```


# MSEIR
Recoding the [Epidemic Calculator](http://gabgoh.github.io/COVID/index.html) which uses a SEIR model with some modifications. In particular:


$T_{inf}$ = infectious period
$T_{inc}$ = latent_period

$\displaystyle \beta = c * p$
$\displaystyle \delta = \frac{1}{T_{inc}}$
$\displaystyle \gamma = \frac{1}{T_{inf}}$
$\displaystyle \mu$ death rate

Therefore
$\displaystyle R_0 = \frac{\delta}{\mu + \delta} \frac{\beta}{\mu + \gamma}$ 

Then the model subdivides the last compartment into $Mild$, $Recovered$, $Dead$, with imputed percentages. 

## Model

$\displaystyle \frac{\partial{S}}{\partial{t}} = -\beta SI - \mu S$
$\displaystyle \frac{\partial{E}}{\partial{t}} = \beta SI  - (\mu + \delta) E$
$\displaystyle \frac{\partial{I}}{\partial{t}} = \delta E - (\gamma + \mu)I$
$\displaystyle \frac{\partial{R}}{\partial{t}} = \gamma I - \mu R$

```{r}
SEIR.model <- function(current_timepoint, state_values, tot_pop, params){
  S = state_values[1]
  E = state_values[2]
  Is = state_values[3]
  Rec = state_values[4]
  D = state_values[5]
  Rem = state_values[6]

  with(
    as.list(parameters), 
    {
      ## compute derivatives
      dS = (-beta_value * S * Is) - mu * S
      dE = (beta_value * S * Is) - (delta_value + mu) * E
      dIs = (delta_value * E) - (gamma_value + mu) * Is
      dRec = p_rec * (gamma_value * Is - mu * Rem)
      dD = mu * (gamma_value * Is - mu * Rem)
      dRem = gamma_value * Is - mu * Rem
      
      # combine 
      results = c(dS, dE, dIs, dRec, dD, dRem)
      list(results)
    }
  )
}

```

## Current data
```{r}
# State parameters
library(RCurl)
library(lubridate)

# US population based on census = N
US_pop_2020 = 329410596

JHU_Infected <- getURL('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Confirmed.csv') %>% 
  read_csv() %>% 
  filter(`Country/Region`=='US') %>%
  gather(date, Infected, -`Province/State`, -`Country/Region`, -Lat, -Long) %>% 
  mutate(date = mdy(date), 
         time_from_0 = date - min(date)) %>% 
  distinct(`Province/State`,date, Infected)

JHU_Recovered <- getURL('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Recovered.csv') %>% 
  read_csv() %>% 
  filter(`Country/Region`=='US') %>%
  gather(date, Recovered, -`Province/State`, -`Country/Region`, -Lat, -Long) %>% 
  mutate(date = mdy(date), 
         time_from_0 = date - min(date))

JHU_Deaths <- getURL('https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_19-covid-Deaths.csv') %>% 
  read_csv() %>% 
  filter(`Country/Region`=='US') %>%
  gather(date, Deaths, -`Province/State`, -`Country/Region`, -Lat, -Long) %>% 
  mutate(date = mdy(date), 
         time_from_0 = date - min(date))

# Current state as JHU dashboard for March 22
N = US_pop_2020
Infected_symptomatic = 26747
Recovered = 176
Deaths = 340
Susceptible = N - (Infected_symptomatic + Recovered + Deaths)
obs_time = 100

```

## Simulation 
```{r}
# Estimated parameters
transmission_probability = 0.07
contact_rate = 22 
infectious_period = 2.9
latent_period = 5.2
time_to_death = 32
case_to_fatality = 0.02

## Derived values
Rt = contact_rate* infectious_period * transmission_probability
timepoints = seq(0, obs_time, by = .5)

initial_values <- c(
  S = (Susceptible - Infected_symptomatic * contact_rate)/N,
  E = round(Infected_symptomatic * contact_rate)/N,
  Is = Infected_symptomatic/N, 
  Rec = Recovered/N,
  D = Deaths/N, 
  Rem = (Deaths + Recovered)/N
)

parameters = c(
  beta_value = contact_rate * transmission_probability, 
  gamma_value = 1 / infectious_period, 
  delta_value = 1 / latent_period,
  mu = case_to_fatality, 
  p_rec = 1 - case_to_fatality
)

R0_est <- with(as.list(parameters), (delta_value/(mu+delta_value))*(beta_value/(mu+gamma_value)))

out <- lsoda(y = initial_values, times = timepoints, func = SEIR.model, parms = parameters)

out <- out %>% 
  as.data.frame()

```

```{r}
out %>% 
  gather(Compartments, perc, -time) %>% 
  ggplot(aes(x=time, y=perc, color=Compartments)) +
  ylim(c(0,1.1))+
  geom_line()+
  theme_clean()+
  scale_color_manual(values = c(S='grey', 
                                E = 'black', 
                                Is = 'red', 
                                Rec = 'green', 
                                D = 'blue', 
                                Rem = 'orange')) +
  labs(title="SEIsR model",
       subtitle=paste0('Contact Rate = ', contact_rate, 
                       '; Rt = ', Rt))
  

```
